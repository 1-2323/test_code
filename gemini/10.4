import requests
from requests.exceptions import Timeout, RequestException
import uuid

class PaymentClient:
    def __init__(self, base_url, api_key, timeout=(3.05, 30)):
        """
        :param timeout: кортеж (connect_timeout, read_timeout)
        """
        self.base_url = base_url
        self.api_key = api_key
        self.timeout = timeout

    def process_payment(self, amount, currency, order_id):
        url = f"{self.base_url}/v1/charge"
        payload = {
            "amount": amount,
            "currency": currency,
            "order_id": order_id,
            "idempotency_key": str(uuid.uuid4())  # Предотвращает дубли
        }
        headers = {"Authorization": f"Bearer {self.api_key}"}

        try:
            response = requests.post(
                url, 
                json=payload, 
                headers=headers, 
                timeout=self.timeout
            )
            response.raise_for_status()
            return {"status": "success", "data": response.json()}

        except Timeout:
            # Важно: Не помечаем платеж как Failed! 
            # Статус транзакции в шлюзе остается неизвестным.
            return {
                "status": "uncertain", 
                "error": "Timeout reached. Check status later."
            }

        except RequestException as e:
            # Сетевые ошибки или 4xx/5xx коды
            return {
                "status": "error", 
                "message": str(e)
            }

    def check_status(self, order_id):
        """Метод для уточнения статуса, если возник Timeout"""
        try:
            url = f"{self.base_url}/v1/status/{order_id}"
            response = requests.get(url, timeout=5)
            return response.json()
        except RequestException:
            return None
