import uuid
from datetime import datetime
from typing import Optional
from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel, Field

app = FastAPI()

# Константы бизнес-логики
PASSING_SCORE = 70
MAX_SCORE = 100

# Модели данных
class TestSubmission(BaseModel):
    user_id: int
    test_id: int
    score: float = Field(..., ge=0, le=MAX_SCORE)

class Certificate(BaseModel):
    certificate_id: str
    user_id: int
    test_id: int
    issue_date: str
    final_score: float
    status: str

@app.post("/test/submit", response_model=Optional[Certificate], status_code=status.HTTP_200_OK)
async def submit_test(submission: TestSubmission):
    # 1. Проверка проходного порога
    if submission.score < PASSING_SCORE:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=f"Score {submission.score} is below passing threshold of {PASSING_SCORE}."
        )

    # 2. Генерация данных сертификата
    # В реальном приложении здесь была бы запись в таблицу Certificates
    certificate_data = {
        "certificate_id": str(uuid.uuid4()),
        "user_id": submission.user_id,
        "test_id": submission.test_id,
        "issue_date": datetime.utcnow().isoformat(),
        "final_score": submission.score,
        "status": "issued"
    }

    return certificate_data
