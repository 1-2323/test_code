from fastapi import APIRouter, Body, HTTPException, status
from motor.motor_asyncio import AsyncIOMotorClient
from typing import List, Dict, Any
from pydantic import BaseModel, Field

router = APIRouter(prefix="/documents", tags=["Documents"])

# Настройка подключения к MongoDB
client = AsyncIOMotorClient("mongodb://localhost:27017")
db = client.my_database
collection = db.documents

class DocumentResponse(BaseModel):
    id: str = Field(alias="_id")
    data: Dict[str, Any]

    class Config:
        allow_population_by_field_name = True

@router.get("/search", response_model=List[Dict[str, Any]])
async def search_documents(
    criteria: Dict[str, Any] = Body(
        ..., 
        example={"status": "active", "type": {"$in": ["pdf", "docx"]}}
    )
):
    try:
        # Выполнение поиска с использованием переданных критериев
        cursor = collection.find(criteria)
        
        # Ограничение выборки (например, первыми 100 документами для безопасности)
        documents = await cursor.to_list(length=100)
        
        # Конвертация ObjectId в строку для корректной сериализации в JSON
        for doc in documents:
            doc["_id"] = str(doc["_id"])
            
        return documents
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"Ошибка при выполнении запроса MongoDB: {str(e)}"
        )
