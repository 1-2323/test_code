import logging
import time
from fastapi import FastAPI, Request
from starlette.middleware.base import BaseHTTPMiddleware

# Настройка логгера для записи в файл
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)s | %(message)s",
    handlers=[
        logging.FileHandler("access_logs.log", encoding="utf-8"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger("RequestLogger")

class RequestLoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # Извлечение данных из заголовков
        user_agent = request.headers.get("user-agent", "Unknown")
        host = request.headers.get("host", "Unknown")
        referer = request.headers.get("referer", "-")
        method = request.method
        url = request.url.path

        start_time = time.time()
        
        # Обработка запроса
        response = await call_next(request)
        
        process_time = round(time.time() - start_time, 4)
        status_code = response.status_code

        # Формирование записи лога
        log_message = (
            f"Method: {method} | Path: {url} | Status: {status_code} | "
            f"User-Agent: {user_agent} | Host: {host} | Referer: {referer} | "
            f"Time: {process_time}s"
        )
        
        logger.info(log_message)
        
        return response

# Применение в приложении
app = FastAPI()
app.add_middleware(RequestLoggingMiddleware)
