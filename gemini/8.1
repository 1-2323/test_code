from fastapi import FastAPI, HTTPException, Request
from pydantic import BaseModel
from typing import Dict, Any, Callable

app = FastAPI()

# --- 1. Логика обработки действий ---

def handle_user_created(data: Dict[str, Any]):
    user_id = data.get("id")
    return {"status": "success", "message": f"User {user_id} added to database"}

def handle_order_placed(data: Dict[str, Any]):
    order_id = data.get("order_id")
    return {"status": "success", "message": f"Order {order_id} sent to warehouse"}

# Карта динамических действий (Action Registry)
ACTION_HANDLERS: Dict[str, Callable] = {
    "user.created": handle_user_created,
    "order.placed": handle_order_placed,
}

# --- 2. Модель данных ---

class WebhookPayload(BaseModel):
    event: str
    data: Dict[str, Any]

# --- 3. Эндпоинт ---

@app.post("/webhook")
async def webhook_receiver(payload: WebhookPayload):
    """
    Принимает POST запрос, определяет тип события и 
    вызывает соответствующий обработчик.
    """
    event_type = payload.event
    
    # Поиск обработчика в реестре
    handler = ACTION_HANDLERS.get(event_type)
    
    if not handler:
        # Если действие неизвестно, возвращаем 400 или игнорируем
        raise HTTPException(status_code=400, detail=f"Unsupported event: {event_type}")
    
    # Выполнение действия
    result = handler(payload.data)
    
    return {
        "event_received": event_type,
        "result": result
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
