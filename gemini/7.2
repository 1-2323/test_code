import uuid
from fastapi import FastAPI, Request, Response
from starlette.middleware.base import BaseHTTPMiddleware

class SessionMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # 1. Пытаемся получить ID сессии из Cookie
        session_id = request.cookies.get("session_id")
        
        # 2. Если Cookie нет, генерируем новый ID
        if not session_id:
            session_id = str(uuid.uuid4())
            # Помечаем в состоянии запроса, что это новая сессия (опционально)
            request.state.new_session = True
        else:
            request.state.new_session = False
        
        # Сохраняем ID в состоянии запроса для доступа в эндпоинтах
        request.state.session_id = session_id

        # 3. Передаем запрос дальше по цепочке
        response: Response = await call_next(request)

        # 4. Устанавливаем Cookie в ответ, если сессия новая
        # (Или обновляем каждый раз для продления срока жизни)
        response.set_cookie(
            key="session_id",
            value=session_id,
            httponly=True,   # Защита от XSS (JS не сможет прочитать cookie)
            samesite="lax",  # Защита от CSRF
            max_age=3600     # Срок жизни в секундах (1 час)
        )
        
        return response

# --- Использование ---

app = FastAPI()
app.add_middleware(SessionMiddleware)

@app.get("/")
async def index(request: Request):
    return {
        "message": "Hello!",
        "session_id": request.state.session_id,
        "is_new": request.state.new_session
    }
