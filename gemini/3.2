import asyncio
import subprocess
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Dict

router = APIRouter(prefix="/admin", tags=["Diagnostics"])

class DiagnosticRequest(BaseModel):
    commands: List[str]

class CommandResult(BaseModel):
    command: str
    stdout: str
    stderr: str
    return_code: int

@router.post("/diagnostics", response_model=Dict[str, List[CommandResult]])
async def run_diagnostics(request: DiagnosticRequest):
    results = []

    for cmd in request.commands:
        try:
            # Асинхронный запуск процесса
            process = await asyncio.create_subprocess_shell(
                cmd,
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE
            )

            # Ожидание завершения и получение вывода
            stdout, stderr = await process.communicate()

            results.append(CommandResult(
                command=cmd,
                stdout=stdout.decode().strip(),
                stderr=stderr.decode().strip(),
                return_code=process.returncode
            ))
        except Exception as e:
            results.append(CommandResult(
                command=cmd,
                stdout="",
                stderr=str(e),
                return_code=-1
            ))

    return {"results": results}
