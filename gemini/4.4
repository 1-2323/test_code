import httpx
from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel

app = FastAPI()

# Конфигурация внешнего API
EXTERNAL_API_URL = "https://api.openai.com/v1/chat/completions"
API_KEY = "your_api_key_here"
SYSTEM_PROMPT = "You are a helpful assistant. Provide a concise answer to the following request:"

class GenerateRequest(BaseModel):
    user_input: str

class GenerateResponse(BaseModel):
    generated_text: str

@app.post("/generate", response_model=GenerateResponse)
async def generate_text(request: GenerateRequest):
    # Формирование промпта с использованием пользовательского ввода
    payload = {
        "model": "gpt-3.5-turbo",
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": request.user_input}
        ],
        "temperature": 0.7
    }
    
    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }

    async with httpx.AsyncClient() as client:
        try:
            response = await client.post(
                EXTERNAL_API_URL, 
                json=payload, 
                headers=headers, 
                timeout=30.0
            )
            response.raise_for_status()
            
            data = response.json()
            # Извлечение текста из ответа (формат OpenAI)
            result_text = data["choices"][0]["message"]["content"]
            
            return {"generated_text": result_text}

        except httpx.HTTPStatusError as e:
            raise HTTPException(
                status_code=e.response.status_code,
                detail=f"External API error: {e.response.text}"
            )
        except Exception as e:
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail=f"Internal server error: {str(e)}"
            )
