import json
import os
from typing import Dict, Any
from pydantic import BaseModel, Field
from fastapi import FastAPI, HTTPException, status

# Константы
SETTINGS_FILE = "global_settings.json"

# Схема данных
class GlobalSettings(BaseModel):
    title: str = Field(..., min_length=1, max_length=100)
    maintenance_mode: bool = False
    api_rates: int = Field(default=60, ge=0)
    
    class Config:
        extra = "allow"

app = FastAPI()

def save_to_storage(data: dict):
    try:
        with open(SETTINGS_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4, ensure_ascii=False)
    except IOError as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Error saving settings: {e}"
        )

@app.post("/api/settings/global", status_code=status.HTTP_200_OK)
async def update_global_settings(settings: GlobalSettings):
    settings_dict = settings.model_dump()
    save_to_storage(settings_dict)
    return {"status": "success", "updated_settings": settings_dict}
