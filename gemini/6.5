import subprocess
import json
import sys
from pathlib import Path

def run_dependency_scan(requirements_file="requirements.txt"):
    """
    Запускает pip-audit и возвращает результат в формате JSON.
    """
    if not Path(requirements_file).exists():
        print(f"Ошибка: Файл {requirements_file} не найден.")
        return None

    print(f"--- Запуск сканирования: {requirements_file} ---")
    
    # Запуск pip-audit через subprocess
    # --format json позволяет нам программно обрабатывать отчет
    result = subprocess.run(
        ["pip-audit", "-r", requirements_file, "--format", "json"],
        capture_output=True,
        text=True
    )

    # pip-audit возвращает non-zero код, если найдены уязвимости
    if result.returncode not in [0, 1]:
        print(f"Ошибка при выполнении pip-audit: {result.stderr}")
        return None

    return json.loads(result.stdout)

def process_report(report):
    """
    Обрабатывает JSON отчет и выводит критические данные.
    """
    if not report:
        return

    vulnerabilities_found = 0
    dependencies = report.get("dependencies", [])

    for dep in dependencies:
        vulns = dep.get("vulns", [])
        if vulns:
            vulnerabilities_found += len(vulns)
            print(f"\n[!] Пакет: {dep['name']} (версия: {dep['version']})")
            for v in vulns:
                print(f"    - ID: {v['id']}")
                print(f"    - Описание: {v['description'][:100]}...")
                print(f"    - Исправлено в версиях: {', '.join(v['fix_versions'])}")

    print("\n--- Итог проверки ---")
    if vulnerabilities_found > 0:
        print(f"Найдено уязвимостей: {vulnerabilities_found}")
        sys.exit(1)  # Завершаем с ошибкой для CI/CD пайплайнов
    else:
        print("Уязвимостей не обнаружено. Все зависимости безопасны.")
        sys.exit(0)

if __name__ == "__main__":
    # Предварительно убедитесь, что pip-audit установлен: pip install pip-audit
    scan_data = run_dependency_scan()
    process_report(scan_data)
