import httpx
import logging
from typing import Optional, Dict, Any

# Настройка логирования для отслеживания запросов
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class SecureExternalClient:
    """
    Клиент для взаимодействия с внешним защищенным API через HTTPS.
    Реализует повторное использование соединений и обработку заголовков.
    """
    
    def __init__(self, base_url: str, api_key: str, timeout: float = 10.0):
        self.base_url = base_url.rstrip('/')
        # Заголовки авторизации, которые будут применяться ко всем запросам
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json",
            "Accept": "application/json"
        }
        self.timeout = timeout
        # Использование Client (сессии) для оптимизации соединений
        self.client = httpx.Client(
            base_url=self.base_url,
            headers=self.headers,
            timeout=self.timeout,
            http2=True  # Поддержка HTTP/2, если сервер ее предоставляет
        )

    def get_resource(self, endpoint: str, params: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """
        Выполняет GET-запрос к защищенному ресурсу.
        """
        try:
            response = self.client.get(endpoint, params=params)
            # Вызывает исключение для кодов 4xx и 5xx
            response.raise_for_status()
            return response.json()
        except httpx.HTTPStatusError as e:
            logger.error(f"Ошибка статуса HTTP: {e.response.status_code} для {endpoint}")
            raise
        except httpx.RequestError as e:
            logger.error(f"Ошибка сети при запросе к {e.request.url}: {e}")
            raise

    def post_data(self, endpoint: str, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Выполняет POST-запрос с JSON-телом.
        """
        try:
            response = self.client.post(endpoint, json=data)
            response.raise_for_status()
            return response.json()
        except httpx.HTTPStatusError as e:
            logger.error(f"Ошибка при сохранении данных в {endpoint}: {e.response.text}")
            raise
        except Exception as e:
            logger.exception(f"Непредвиденная ошибка: {e}")
            raise

    def close(self):
        """Закрывает сессию клиента."""
        self.client.close()

    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.close()
