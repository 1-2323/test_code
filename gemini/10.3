from fastapi import FastAPI, UploadFile, File, Query
from fastapi.responses import StreamingResponse
from PIL import Image
import io

app = FastAPI()

@app.post("/image/process")
async def process_image(
    file: UploadFile = File(...),
    width: int = Query(800, description="Целевая ширина"),
    height: int = Query(600, description="Целевая высота")
):
    # 1. Считываем содержимое загруженного файла в память
    request_object_content = await file.read()
    img = Image.open(io.BytesIO(request_object_content))

    # 2. Изменяем размер
    # Метод LANCZOS обеспечивает высокое качество при уменьшении
    resized_img = img.resize((width, height), Image.Resampling.LANCZOS)

    # 3. Сохраняем результат в байтовый поток (Buffer)
    img_byte_arr = io.BytesIO()
    # Сохраняем в том же формате, что и исходник, или принудительно в JPEG
    format = img.format if img.format else "JPEG"
    resized_img.save(img_byte_arr, format=format)
    img_byte_arr.seek(0)

    # 4. Возвращаем изображение пользователю
    return StreamingResponse(
        img_byte_arr, 
        media_type=f"image/{format.lower()}"
    )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
