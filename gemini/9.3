import logging
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from datetime import datetime
from typing import Optional

# Настройка логирования
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - [TXID: %(message)s]'
)
logger = logging.getLogger(__name__)

app = FastAPI()

# Модель данных для входящего лога
class TransactionStep(BaseModel):
    transaction_id: str
    step_name: str  # например: "INITIATED", "GATEWAY_SENT", "SUCCESS"
    status: str     # "info", "warning", "error"
    amount: Optional[float] = None
    currency: Optional[str] = "USD"
    details: Optional[str] = None

@app.post("/log/transaction")
async def log_transaction_step(step: TransactionStep):
    log_payload = (
        f"{step.transaction_id}] | Step: {step.step_name} | "
        f"Status: {step.status.upper()} | Details: {step.details}"
    )
    
    # Логирование в зависимости от статуса
    if step.status.lower() == "error":
        logger.error(log_payload)
    elif step.status.lower() == "warning":
        logger.warning(log_payload)
    else:
        logger.info(log_payload)
    
    return {"message": "Log recorded", "transaction_id": step.transaction_id}
