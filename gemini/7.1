from fastapi import FastAPI, HTTPException, Response, Depends, status
from pydantic import BaseModel
from passlib.context import CryptContext
from uuid import uuid4

app = FastAPI()

# Настройка хеширования паролей (никогда не храните пароли в открытом виде!)
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# Имитация базы данных
fake_db = {
    "user123": {
        "username": "admin",
        "hashed_password": pwd_context.hash("secret_password")
    }
}

# Имитация хранилища сессий (в реальном проекте используйте Redis)
sessions = {}

class LoginSchema(BaseModel):
    username: str
    password: str

@app.post("/login")
async def login(data: LoginSchema, response: Response):
    # 1. Поиск пользователя
    user = fake_db.get("user123")  # В реальности: DB query по data.username
    
    if not user or not pwd_context.verify(data.password, user["hashed_password"]):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Неверный логин или пароль"
        )

    # 2. Создание сессии
    session_id = str(uuid4())
    sessions[session_id] = {"username": user["username"]}

    # 3. Установка HTTP-Only Cookie (защита от XSS)
    response.set_cookie(
        key="session_id",
        value=session_id,
        httponly=True,
        max_age=3600,  # 1 час
        samesite="lax"
    )

    return {"message": "Успешный вход"}
