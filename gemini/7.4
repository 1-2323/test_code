from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel
import pyotp

app = FastAPI()

# Имитация базы данных
fake_db = {
    "user_id_123": {
        "username": "ivan_ivanov",
        "otp_secret": "JBSWY3DPEHPK3PXP",  # Секрет, сохраненный ранее
        "is_2fa_enabled": True
    }
}

# Модель данных для запроса
class Verify2FARequest(BaseModel):
    user_id: str
    code: str  # Код из приложения (например, Google Authenticator)

@app.post("/2fa/verify")
async def verify_2fa(request: Verify2FARequest):
    user = fake_db.get(request.user_id)
    
    if not user or not user.get("is_2fa_enabled"):
        raise HTTPException(status_code=404, detail="User not found or 2FA not enabled")

    # Создаем объект TOTP с секретом пользователя
    totp = pyotp.TOTP(user["otp_secret"])

    # Проверяем код (verify возвращает True/False)
    # valid_window=1 позволяет небольшое расхождение во времени (±30 сек)
    if totp.verify(request.code, valid_window=1):
        # Здесь обычно генерируется и возвращается JWT-токен
        return {
            "status": "success",
            "message": "Authentication successful",
            "access_token": "your_jwt_token_here"
        }
    else:
        raise HTTPException(status_code=400, detail="Invalid verification code")
