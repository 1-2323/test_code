import json
from pathlib import Path
from typing import Any, Dict


class ConfigError(Exception):
    pass


def load_config(
    path: str | Path,
    defaults: Dict[str, Any],
) -> Dict[str, Any]:
    """
    Загружает конфигурацию из JSON-файла, применяя fallback-значения из defaults.
    """
    config: Dict[str, Any] = {}

    try:
        with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)
            if not isinstance(data, dict):
                raise ConfigError("Config file must contain a JSON object")
            config.update(data)
    except FileNotFoundError:
        pass
    except (OSError, json.JSONDecodeError) as e:
        raise ConfigError(f"Failed to load config: {e}") from e

    for key, value in defaults.items():
        config.setdefault(key, value)

    return config
