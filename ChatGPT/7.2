import time
from typing import Callable, Optional
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.requests import Request
from starlette.responses import Response
import secrets

SESSION_COOKIE = "session_id"
SESSION_TTL = 60 * 60  # 1 час

# session_id -> {"user": str | None, "expires": float}
SESSIONS: dict[str, dict] = {}


class SessionMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next: Callable):
        now = time.time()
        session_id: Optional[str] = request.cookies.get(SESSION_COOKIE)
        session = None

        if session_id:
            data = SESSIONS.get(session_id)
            if data and data["expires"] > now:
                data["expires"] = now + SESSION_TTL
                session = data
            else:
                SESSIONS.pop(session_id, None)
                session_id = None

        if not session_id:
            session_id = secrets.token_urlsafe(32)
            session = {"user": None, "expires": now + SESSION_TTL}
            SESSIONS[session_id] = session

        request.state.session = session
        request.state.session_id = session_id

        response: Response = await call_next(request)

        response.set_cookie(
            key=SESSION_COOKIE,
            value=session_id,
            httponly=True,
            secure=True,
            samesite="lax",
            max_age=SESSION_TTL,
        )

        return response
