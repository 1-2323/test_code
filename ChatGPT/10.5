from typing import Callable, Iterator
import xml.etree.ElementTree as ET


class XMLProcessingError(Exception):
    pass


def process_large_xml(
    file_path: str,
    on_element: Callable[[ET.Element], None],
    target_tag: str | None = None,
) -> None:
    """
    Потоково обрабатывает большой XML-файл, вызывая on_element для каждого элемента.

    :param file_path: путь к XML-файлу
    :param on_element: callback для обработки элемента
    :param target_tag: если указан, обрабатываются только элементы с этим тегом
    """
    try:
        context = ET.iterparse(file_path, events=("end",))
        for event, elem in context:
            if target_tag is None or elem.tag == target_tag:
                on_element(elem)
            elem.clear()
    except (ET.ParseError, OSError) as e:
        raise XMLProcessingError(f"Failed to process XML file: {e}") from e
