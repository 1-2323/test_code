import logging
from datetime import datetime
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.requests import Request
from starlette.responses import Response

logger = logging.getLogger("auth")
logger.setLevel(logging.INFO)

class AuthLoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next) -> Response:
        response = await call_next(request)

        if request.url.path == "/login":
            event_time = datetime.utcnow().isoformat()
            client_ip = request.client.host if request.client else "unknown"

            if response.status_code == 200:
                logger.info(
                    "LOGIN_SUCCESS time=%s ip=%s",
                    event_time,
                    client_ip,
                )
            elif response.status_code in (401, 403):
                logger.warning(
                    "LOGIN_FAILED time=%s ip=%s status=%s",
                    event_time,
                    client_ip,
                    response.status_code,
                )

        return response
