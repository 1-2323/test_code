from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel, conlist
from sqlalchemy.orm import Session
from decimal import Decimal

from db import get_db, Order, OrderItem, Product  # предполагается существующая инфраструктура

app = FastAPI()


class CheckoutItem(BaseModel):
    product_id: int
    quantity: int


class CheckoutRequest(BaseModel):
    items: conlist(CheckoutItem, min_items=1)
    total_price: Decimal


@app.post("/checkout")
def checkout(payload: CheckoutRequest, db: Session = Depends(get_db)):
    product_ids = [item.product_id for item in payload.items]
    products = {
        p.id: p for p in db.query(Product).filter(Product.id.in_(product_ids)).all()
    }

    if len(products) != len(product_ids):
        raise HTTPException(status_code=400, detail="Invalid product")

    calculated_total = Decimal("0")
    for item in payload.items:
        if item.quantity <= 0:
            raise HTTPException(status_code=400, detail="Invalid quantity")
        calculated_total += products[item.product_id].price * item.quantity

    if calculated_total != payload.total_price:
        raise HTTPException(status_code=400, detail="Total price mismatch")

    order = Order(total_price=calculated_total)
    db.add(order)
    db.flush()

    for item in payload.items:
        db.add(
            OrderItem(
                order_id=order.id,
                product_id=item.product_id,
                quantity=item.quantity,
                price=products[item.product_id].price,
            )
        )

    db.commit()

    return {"order_id": order.id, "status": "created"}
