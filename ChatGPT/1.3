from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, Field
from typing import Dict, Any
import json
import os
import tempfile

app = FastAPI()

CONFIG_PATH = "global_settings.json"


class GlobalSettings(BaseModel):
    title: str | None = None
    maintenance_mode: bool | None = None
    api_rates: Dict[str, Any] | None = None


def save_config(data: dict) -> None:
    directory = os.path.dirname(CONFIG_PATH) or "."
    with tempfile.NamedTemporaryFile("w", dir=directory, delete=False) as tmp:
        json.dump(data, tmp, ensure_ascii=False, indent=2)
        tmp.flush()
        os.fsync(tmp.fileno())
    os.replace(tmp.name, CONFIG_PATH)


def load_config() -> dict:
    if not os.path.exists(CONFIG_PATH):
        return {}
    with open(CONFIG_PATH, "r", encoding="utf-8") as f:
        return json.load(f)


@app.post("/api/settings/global")
def update_global_settings(settings: GlobalSettings):
    try:
        current = load_config()
        updated = {**current, **settings.model_dump(exclude_unset=True)}
        save_config(updated)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
