import requests
from typing import Any, Dict


class PaymentError(Exception):
    pass


class PaymentClient:
    def __init__(self, base_url: str, timeout: float = 5.0) -> None:
        self.base_url = base_url.rstrip("/")
        self.timeout = timeout

    def _request(self, endpoint: str, payload: Dict[str, Any]) -> Dict[str, Any]:
        try:
            response = requests.post(
                f"{self.base_url}/{endpoint.lstrip('/')}",
                json=payload,
                timeout=self.timeout,
            )
            response.raise_for_status()
        except requests.Timeout as e:
            raise PaymentError("Payment API timeout") from e
        except requests.RequestException as e:
            raise PaymentError(f"Payment API request failed: {e}") from e

        try:
            data = response.json()
        except ValueError as e:
            raise PaymentError("Invalid JSON response from payment API") from e

        if not isinstance(data, dict):
            raise PaymentError("Malformed payment API response")

        return data

    def process_payment(self, payload: Dict[str, Any]) -> Dict[str, Any]:
        data = self._request("/payment/process", payload)

        status = data.get("status")
        if status == "success":
            return data
        if status == "failed":
            raise PaymentError(data.get("error", "Payment failed"))

        raise PaymentError("Unknown payment status")
