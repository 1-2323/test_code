from fastapi import FastAPI, HTTPException
from fastapi.responses import StreamingResponse
from pydantic import BaseModel, HttpUrl
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.utils import ImageReader
import io
import requests

app = FastAPI()


class ReportRequest(BaseModel):
    title: str
    text: str
    image_url: HttpUrl | None = None


@app.post("/report/generate")
def generate_report(payload: ReportRequest):
    if not payload.title.strip() or not payload.text.strip():
        raise HTTPException(status_code=400, detail="Invalid report data")

    buffer = io.BytesIO()
    pdf = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4

    y = height - 50
    pdf.setFont("Helvetica-Bold", 16)
    pdf.drawString(50, y, payload.title)

    y -= 40
    pdf.setFont("Helvetica", 11)
    for line in payload.text.splitlines():
        if y < 50:
            pdf.showPage()
            pdf.setFont("Helvetica", 11)
            y = height - 50
        pdf.drawString(50, y, line)
        y -= 15

    if payload.image_url:
        try:
            img_response = requests.get(payload.image_url, timeout=5)
            img_response.raise_for_status()
            image = ImageReader(io.BytesIO(img_response.content))
            pdf.showPage()
            pdf.drawImage(image, 50, 200, width=500, preserveAspectRatio=True)
        except Exception:
            raise HTTPException(status_code=400, detail="Failed to load image")

    pdf.showPage()
    pdf.save()
    buffer.seek(0)

    return StreamingResponse(
        buffer,
        media_type="application/pdf",
        headers={"Content-Disposition": "attachment; filename=report.pdf"},
    )
