from typing import Optional
from fastapi import APIRouter, Depends, Query
from sqlalchemy import select, func
from sqlalchemy.ext.asyncio import AsyncSession

from db import get_async_session
from models import User

router = APIRouter(prefix="/admin/users", tags=["admin-users"])


@router.get("/search")
async def search_users(
    name: Optional[str] = Query(None, min_length=1),
    role: Optional[str] = Query(None),
    page: int = Query(1, ge=1),
    limit: int = Query(20, ge=1, le=100),
    session: AsyncSession = Depends(get_async_session),
):
    filters = []

    if name:
        filters.append(User.name.ilike(f"%{name}%"))

    if role:
        filters.append(User.role == role)

    base_query = select(User).where(*filters)
    count_query = select(func.count()).select_from(User).where(*filters)

    total = await session.scalar(count_query)

    result = await session.execute(
        base_query
        .offset((page - 1) * limit)
        .limit(limit)
        .order_by(User.id)
    )

    users = result.scalars().all()

    return {
        "items": users,
        "total": total,
        "page": page,
        "limit": limit,
    }
