from fastapi import FastAPI, Request, HTTPException
from typing import Dict, Callable, Any, List

app = FastAPI()

# ---------- Action handlers ----------

def send_email(payload: Dict[str, Any]) -> Dict[str, Any]:
    email = payload.get("email")
    if not email:
        raise ValueError("email is required")

    # Тут реальная логика отправки
    print(f"Sending email to {email}")

    return {"status": "email_sent", "email": email}


def create_task(payload: Dict[str, Any]) -> Dict[str, Any]:
    title = payload.get("title")
    if not title:
        raise ValueError("title is required")

    # Тут реальная логика создания задачи
    print(f"Creating task: {title}")

    return {"status": "task_created", "title": title}


# ---------- Action registry ----------

ACTION_HANDLERS: Dict[str, Callable[[Dict[str, Any]], Dict[str, Any]]] = {
    "send_email": send_email,
    "create_task": create_task,
}

# ---------- Webhook endpoint ----------

@app.post("/webhook")
async def webhook(request: Request):
    payload = await request.json()

    results: List[Dict[str, Any]] = []

    # Поддержка одиночного action
    if "action" in payload:
        actions = [{
            "type": payload["action"],
            "payload": payload.get("data", {})
        }]
    # Поддержка списка actions
    elif "actions" in payload:
        actions = payload["actions"]
    else:
        raise HTTPException(status_code=400, detail="No actions provided")

    for action in actions:
        action_type = action.get("type")
        action_payload = action.get("payload", {})

        handler = ACTION_HANDLERS.get(action_type)
        if not handler:
            results.append({
                "action": action_type,
                "status": "skipped",
                "reason": "unknown_action"
            })
            continue

        try:
            result = handler(action_payload)
            results.append({
                "action": action_type,
                "status": "success",
                "result": result
            })
        except Exception as e:
            results.append({
                "action": action_type,
                "status": "error",
                "error": str(e)
            })

    return {
        "ok": True,
        "results": results
    }
