from fastapi import APIRouter, UploadFile, File, HTTPException
from PIL import Image
from pathlib import Path
import uuid

router = APIRouter()

AVATAR_DIR = Path("avatars")
AVATAR_DIR.mkdir(parents=True, exist_ok=True)

ALLOWED_MIME_TYPES = {"image/jpeg", "image/png"}
MAX_FILE_SIZE = 5 * 1024 * 1024  # 5 MB
AVATAR_SIZE = (256, 256)


@router.post("/profile/avatar")
async def upload_avatar(file: UploadFile = File(...)) -> dict:
    if file.content_type not in ALLOWED_MIME_TYPES:
        raise HTTPException(status_code=400, detail="Unsupported image type")

    contents = await file.read()
    if len(contents) > MAX_FILE_SIZE:
        raise HTTPException(status_code=400, detail="File too large")

    try:
        image = Image.open(file.file)
        image.verify()
        file.file.seek(0)
        image = Image.open(file.file).convert("RGB")
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid image file")

    image = image.resize(AVATAR_SIZE, Image.LANCZOS)

    filename = f"{uuid.uuid4().hex}.jpg"
    path = AVATAR_DIR / filename
    image.save(path, format="JPEG", quality=90, optimize=True)

    return {"avatar": filename}
