import secrets
from datetime import datetime, timedelta

from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel, EmailStr
from sqlalchemy import Column, Integer, String, DateTime, create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session

DATABASE_URL = "sqlite:///./app.db"
RESET_TOKEN_TTL = timedelta(hours=1)

engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False)
Base = declarative_base()
app = FastAPI()


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True, nullable=False)


class PasswordResetToken(Base):
    __tablename__ = "password_reset_tokens"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, nullable=False)
    token = Column(String, unique=True, nullable=False)
    expires_at = Column(DateTime, nullable=False)


Base.metadata.create_all(bind=engine)


class PasswordResetRequest(BaseModel):
    email: EmailStr


def get_db() -> Session:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


def send_reset_email(email: str, token: str) -> None:
    reset_link = f"https://example.com/password-reset/confirm?token={token}"
    # реализация отправки email (SMTP / сторонний сервис)
    pass


@app.post("/password-reset/request", status_code=204)
def password_reset_request(
    data: PasswordResetRequest,
    db: Session = Depends(get_db),
):
    user = db.query(User).filter(User.email == data.email).first()
    if not user:
        return

    token = secrets.token_urlsafe(32)
    expires_at = datetime.utcnow() + RESET_TOKEN_TTL

    db.query(PasswordResetToken).filter(
        PasswordResetToken.user_id == user.id
    ).delete()

    db.add(
        PasswordResetToken(
            user_id=user.id,
            token=token,
            expires_at=expires_at,
        )
    )
    db.commit()

    send_reset_email(user.email, token)
