from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, HttpUrl
import requests
from bs4 import BeautifulSoup

app = FastAPI()


class PreviewRequest(BaseModel):
    url: HttpUrl


@app.post("/preview")
def preview_link(payload: PreviewRequest):
    try:
        resp = requests.get(payload.url, timeout=5)
        resp.raise_for_status()
    except requests.RequestException:
        raise HTTPException(status_code=400, detail="Failed to fetch URL")

    soup = BeautifulSoup(resp.text, "html.parser")

    title = soup.title.string.strip() if soup.title and soup.title.string else None
    description = None

    meta_desc = soup.find("meta", attrs={"name": "description"})
    if meta_desc and meta_desc.get("content"):
        description = meta_desc["content"].strip()

    return {
        "title": title,
        "description": description,
    }
