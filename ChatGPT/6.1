from datetime import datetime
from dateutil import parser, tz


class DateUtility:
    """
    Utility for parsing and formatting dates from user input
    using python-dateutil.
    """

    @staticmethod
    def parse(date_str: str, default_tz: str | None = None) -> datetime:
        """
        Parse a date string into a datetime object.

        :param date_str: User-provided date string
        :param default_tz: IANA timezone name (e.g. "Europe/Moscow"),
                           applied if parsed datetime is naive
        :return: timezone-aware or naive datetime
        """
        if not date_str:
            raise ValueError("date_str must be a non-empty string")

        try:
            dt = parser.parse(date_str)
        except (ValueError, TypeError) as exc:
            raise ValueError(f"Unable to parse date: {date_str}") from exc

        if dt.tzinfo is None and default_tz:
            tzinfo = tz.gettz(default_tz)
            if tzinfo is None:
                raise ValueError(f"Unknown timezone: {default_tz}")
            dt = dt.replace(tzinfo=tzinfo)

        return dt

    @staticmethod
    def format(
        dt: datetime,
        fmt: str = "%Y-%m-%d %H:%M:%S",
        target_tz: str | None = None,
    ) -> str:
        """
        Format a datetime object into a string.

        :param dt: datetime to format
        :param fmt: strftime-compatible format string
        :param target_tz: IANA timezone name to convert before formatting
        :return: formatted date string
        """
        if not isinstance(dt, datetime):
            raise ValueError("dt must be a datetime instance")

        if target_tz:
            tzinfo = tz.gettz(target_tz)
            if tzinfo is None:
                raise ValueError(f"Unknown timezone: {target_tz}")
            dt = dt.astimezone(tzinfo)

        return dt.strftime(fmt)
