import os
import base64
from cryptography.hazmat.primitives.ciphers.aead import AESGCM
from cryptography.hazmat.primitives.kdf.hkdf import HKDF
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.backends import default_backend
from secrets import token_bytes


class SecretManager:
    def __init__(self, env_key_name: str = "SECRET_KEY"):
        master_key = os.getenv(env_key_name)
        if not master_key:
            raise RuntimeError("Secret key not found in environment variables")

        self._key = self._derive_key(master_key.encode())

    @staticmethod
    def _derive_key(master_key: bytes) -> bytes:
        return HKDF(
            algorithm=hashes.SHA256(),
            length=32,
            salt=None,
            info=b"secret-manager",
            backend=default_backend(),
        ).derive(master_key)

    def encrypt(self, plaintext: str) -> str:
        aesgcm = AESGCM(self._key)
        nonce = token_bytes(12)
        ciphertext = aesgcm.encrypt(nonce, plaintext.encode(), None)
        return base64.b64encode(nonce + ciphertext).decode()

    def decrypt(self, encrypted: str) -> str:
        raw = base64.b64decode(encrypted.encode())
        nonce, ciphertext = raw[:12], raw[12:]
        aesgcm = AESGCM(self._key)
        return aesgcm.decrypt(nonce, ciphertext, None).decode()
