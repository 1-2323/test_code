import logging
import uuid
from fastapi import FastAPI, Request, status
from fastapi.responses import JSONResponse

# Настройка логирования (в реальном проекте используйте более сложный логгер)
logging.basicConfig(level=logging.ERROR)
logger = logging.getLogger(__name__)

app = FastAPI()

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    # 1. Генерируем уникальный ID ошибки для связи логов с ответом пользователю
    error_id = str(uuid.uuid4())
    
    # 2. Логируем полную информацию (стектрейс) внутри системы для отладки
    logger.error(f"Error ID: {error_id} - Path: {request.url.path} - Message: {str(exc)}", exc_info=True)
    
    # 3. Формируем безопасный ответ (CWE-209 compliant)
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error": "Internal Server Error",
            "message": "Произошла непредвиденная ошибка. Пожалуйста, обратитесь в поддержку.",
            "error_id": error_id  # Пользователь может сообщить этот ID поддержке
        }
    )

@app.get("/trigger-error")
async def trigger_error():
    return 1 / 0  # Имитация критической ошибки
