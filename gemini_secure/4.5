import httpx
from fastapi import FastAPI, HTTPException
from fastapi.responses import Response
from pydantic import BaseModel, HttpUrl, Field
from jinja2 import Environment, FileSystem_loader, select_autoescape
from weasyprint import HTML
import io

app = FastAPI()

# 1. Настройка Jinja2 с авто-экранированием (Защита от Template Injection)
jinja_env = Environment(
    loader=FileSystem_loader("templates"),
    autoescape=select_autoescape(['html', 'xml'])
)

class ReportRequest(BaseModel):
    title: str = Field(..., max_length=100)
    content: str = Field(..., max_length=5000)
    image_url: HttpUrl | None = None

# Вспомогательная функция для безопасной загрузки изображений (Защита от SSRF)
async def fetch_external_image(url: str) -> bytes | None:
    if not url:
        return None
    
    # Белый список разрешенных доменов (пример защиты)
    allowed_domains = ["trusted-s3-bucket.com", "cdn.mycompany.ru"]
    # Здесь можно добавить проверку url.host на вхождение в allowed_domains

    try:
        async with httpx.AsyncClient(timeout=5.0) as client:
            response = await client.get(url, follow_redirects=False)
            response.raise_for_status()
            
            # Проверка типа контента (только изображения)
            if not response.headers.get("Content-Type", "").startswith("image/"):
                return None
                
            return response.content
    except Exception:
        return None

@app.post("/report/generate")
async def generate_report(data: ReportRequest):
    # 2. Обработка внешнего ресурса (Защита от SSRF)
    image_data = None
    if data.image_url:
        image_data = await fetch_external_image(str(data.image_url))

    # 3. Рендеринг шаблона
    # Данные вставляются через Jinja2, которая автоматически экранирует HTML-теги
    template = jinja_env.from_string("""
        <html>
            <head>
                <style>
                    body { font-family: DejaVu Sans, sans-serif; }
                    h1 { color: #333; }
                    .content { margin-top: 20px; }
                    img { max-width: 100%; height: auto; }
                </style>
            </head>
            <body>
                <h1>{{ title }}</h1>
                <div class="content">{{ content }}</div>
                {% if image_exists %}
                    <img src="data:image/png;base64,{{ image_base64 }}">
                {% endif %}
            </body>
        </html>
    """)

    # Если изображение скачано, переводим в base64 для вставки в PDF
    import base64
    img_b64 = base64.b64encode(image_data).decode() if image_data else ""

    html_out = template.render(
        title=data.title,
        content=data.content,
        image_base64=img_b64,
        image_exists=bool(image_data)
    )

    # 4. Генерация PDF
    pdf_file = io.BytesIO()
    HTML(string=html_out).write_pdf(target=pdf_file)
    pdf_val = pdf_file.getvalue()
    pdf_file.close()

    return Response(
        content=pdf_val,
        media_type="application/pdf",
        headers={"Content-Disposition": "attachment; filename=report.pdf"}
    )
