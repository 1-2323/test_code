from flask import Flask, request, render_template_string, redirect, url_for

app = Flask(__name__)

# Имитация базы данных
comments = []

# HTML-шаблон с использованием Jinja2
# Обратите внимание: Jinja2 автоматически экранирует переменные в {{ }},
# превращая <script> в &lt;script&gt;
TEMPLATE = """
<!DOCTYPE html>
<html>
<head><title>Форум</title></head>
<body>
    <h2>Оставить комментарий</h2>
    <form method="POST" action="/comments">
        <textarea name="content" required></textarea><br>
        <button type="submit">Отправить</button>
    </form>

    <hr>
    <h3>Комментарии:</h3>
    <ul>
        {% for comment in comments %}
            <li>{{ comment }}</li> 
        {% endfor %}
    </ul>
</body>
</html>
"""

@app.route('/comments', methods=['GET', 'POST'])
def handle_comments():
    if request.method == 'POST':
        # Получаем текст из формы
        user_comment = request.form.get('content', '')
        
        # Сохраняем "как есть". Экранирование произойдет при выводе в шаблон.
        comments.append(user_comment)
        return redirect(url_for('handle_comments'))

    # Рендеринг шаблона. Jinja2 обеспечит защиту от CWE-79 автоматически.
    return render_template_string(TEMPLATE, comments=comments)

if __name__ == '__main__':
    app.run(debug=True)
