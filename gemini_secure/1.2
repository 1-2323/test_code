from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select

# Предположим, у вас есть функции для получения сессии и текущего юзера
from database import get_db
from auth import get_current_user 
from models import Order, User
from schemas import OrderRead

router = APIRouter()

@router.get("/orders/{order_id}", response_model=OrderRead)
async def get_order(
    order_id: int,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    # 1. Формируем запрос с фильтрацией по ID заказа
    query = select(Order).where(Order.id == order_id)
    result = await db.execute(query)
    order = result.scalar_one_or_none()

    # 2. Проверяем существование заказа
    if not order:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Order not found"
        )

    # 3. Защита от IDOR: проверяем принадлежность заказа пользователю
    # Даже если злоумышленник угадает чужой order_id, проверка его остановит
    if order.user_id != current_user.id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Not enough permissions to access this order"
        )

    return order
