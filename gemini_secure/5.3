import os
from werkzeug.security import generate_password_hash
from database import db, User  # Предполагаемая структура вашего приложения

def initialize_app():
    # 1. Извлекаем данные из переменных окружения (не храним в коде!)
    admin_email = os.getenv("ADMIN_EMAIL", "admin@example.com")
    admin_password = os.getenv("ADMIN_PASSWORD")

    if not admin_password:
        print("Ошибка: Переменная окружения ADMIN_PASSWORD не установлена.")
        return

    # Проверяем, существует ли уже админ
    existing_admin = User.query.filter_by(role='admin').first()
    
    if not existing_admin:
        print(f"Создание учетной записи администратора для {admin_email}...")
        
        new_admin = User(
            email=admin_email,
            password_hash=generate_password_hash(admin_password),
            role='admin',
            # Флаг обязательной смены пароля
            needs_password_change=True 
        )
        
        db.session.add(new_admin)
        db.session.commit()
        print("Администратор успешно создан.")
    else:
        print("Администратор уже существует в системе.")

if __name__ == "__main__":
    initialize_app()
