import logging
import os
import gzip
import shutil
from logging.handlers import RotatingFileHandler
import stat

class SecureRotatedHandler(RotatingFileHandler):
    """
    Кастомный обработчик: ротация + сжатие + защита от записи.
    """
    def rotator(self, source, dest):
        # Сжимаем файл лога в .gz
        with open(source, 'rb') as f_in:
            with gzip.open(f"{dest}.gz", 'wb') as f_out:
                shutil.copyfileobj(f_in, f_out)
        os.remove(source)
        
        # Защита: устанавливаем права "только чтение" для владельца (0o400)
        # Это предотвращает случайное изменение или удаление процессами
        os.chmod(f"{dest}.gz", stat.S_IREAD)

    def namer(self, name):
        return name + ".rotated"

def setup_secure_logging(log_file):
    logger = logging.getLogger("SecureLogger")
    logger.setLevel(logging.INFO)

    # Параметры: файл, макс. байт (10МБ), кол-во резервных копий (5)
    handler = SecureRotatedHandler(
        log_file, maxBytes=10*1024*1024, backupCount=5, encoding='utf-8'
    )
    
    # Настройка именования и ротации
    handler.rotator = handler.rotator
    handler.namer = handler.namer
    
    formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    
    return logger

# Пример использования
if __name__ == "__main__":
    log = setup_secure_logging("app_security.log")
    log.info("Система логирования запущена. Данные защищены.")
