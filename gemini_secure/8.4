from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel, EmailStr, Field
from typing import List
from motor.motor_asyncio import AsyncIOMotorClient # Пример для MongoDB

app = FastAPI()

# --- Схема данных (Валидация) ---
class UserImport(BaseModel):
    external_id: int = Field(..., gt=0, description="ID из внешней системы")
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr
    age: int = Field(None, ge=0, le=120)

class ImportRequest(BaseModel):
    items: List[UserImport] = Field(..., min_items=1)

# --- Настройка БД (пример с MongoDB) ---
# Для SQL (PostgreSQL) логика будет схожей с использованием bulk_insert
client = AsyncIOMotorClient("mongodb://localhost:27017")
db = client.import_database

@app.post("/import", status_code=status.HTTP_201_CREATED)
async def import_data(payload: ImportRequest):
    """
    Принимает список объектов, валидирует их и сохраняет в БД.
    """
    try:
        # Преобразуем Pydantic модели в словари для вставки
        data_to_insert = [item.model_dump() for item in payload.items]
        
        # Оптимально: массовая вставка (Bulk Insert) вместо цикла
        result = await db.users.insert_many(data_to_insert)
        
        return {
            "status": "success",
            "imported_count": len(result.inserted_ids),
            "ids": [str(id) for id in result.inserted_ids]
        }
        
    except Exception as e:
        # Логируем ошибку и возвращаем понятный ответ
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Ошибка при сохранении в базу: {str(e)}"
        )
