import requests
import psycopg2
import time
import os

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
DB_CONFIG = {
    "dbname": "your_db",
    "user": "admin",
    "password": "password",
    "host": "localhost",
    "port": "5432"
}

EXTERNAL_SERVICES = [
    {"name": "Payment Gateway", "url": "https://api.stripe.com/health"},
    {"name": "Auth Provider", "url": "https://auth.example.com/status"}
]

TELEGRAM_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
TELEGRAM_CHAT_ID = "–í–ê–®_CHAT_ID"
CHECK_INTERVAL = 60  # –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

def send_alert(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"""
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {"chat_id": TELEGRAM_CHAT_ID, "text": f"üö® ALERT: {message}"}
    try:
        requests.post(url, json=payload, timeout=5)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–∞: {e}")

def check_db():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    try:
        conn = psycopg2.connect(**DB_CONFIG, connect_timeout=3)
        conn.close()
        return True, None
    except Exception as e:
        return False, f"Database is DOWN: {str(e)}"

def check_external_services():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö API"""
    errors = []
    for service in EXTERNAL_SERVICES:
        try:
            response = requests.get(service['url'], timeout=5)
            if response.status_code != 200:
                errors.append(f"{service['name']} returned status {response.status_code}")
        except Exception as e:
            errors.append(f"{service['name']} is unreachable: {str(e)}")
    return errors

def run_monitor():
    print("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω...")
    while True:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
        db_ok, db_error = check_db()
        if not db_ok:
            send_alert(db_error)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
        service_errors = check_external_services()
        if service_errors:
            send_alert("\n".join(service_errors))

        time.sleep(CHECK_INTERVAL)

if __name__ == "__main__":
    run_monitor()
