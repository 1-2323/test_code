import json
import os
import sys

# Дефолтные значения (Fallback)
DEFAULT_CONFIG = {
    "host": "127.0.0.1",
    "port": 8080,
    "debug": False,
    "database_url": None  # Обязательное поле, оставим None для проверки
}

def load_config(config_path: str) -> dict:
    """
    Загружает конфигурацию из JSON файла с поддержкой fallback-значений.
    Завершает работу приложения при критических ошибках.
    """
    
    # 1. Проверяем существование файла
    if not os.path.exists(config_path):
        print(f"КРИТИЧЕСКАЯ ОШИБКА: Файл конфигурации '{config_path}' не найден.")
        sys.exit(1)

    try:
        # 2. Чтение и парсинг JSON
        with open(config_path, 'r', encoding='utf-8') as f:
            user_config = json.load(f)
            
    except json.JSONDecodeError as e:
        print(f"КРИТИЧЕСКАЯ ОШИБКА: Ошибка в формате JSON: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"КРИТИЧЕСКАЯ ОШИБКА: Непредвиденная ошибка при чтении файла: {e}")
        sys.exit(1)

    # 3. Слияние с дефолтными значениями (Мягкое обновление)
    # Пользовательские значения перезаписывают дефолтные
    config = {**DEFAULT_CONFIG, **user_config}

    # 4. Валидация критических параметров
    validate_config(config)

    return config

def validate_config(config: dict):
    """Проверка обязательных полей, без которых приложение не может работать."""
    if config.get("database_url") is None:
        print("КРИТИЧЕСКАЯ ОШИБКА: Параметр 'database_url' не задан в конфигурации.")
        sys.exit(1)
    
    if not isinstance(config.get("port"), int):
        print("КРИТИЧЕСКАЯ ОШИБКА: Порт должен быть числом.")
        sys.exit(1)

# Пример использования
if __name__ == "__main__":
    # Создадим временный файл для теста, если его нет
    # config = load_config("config.json")
    # print("Конфигурация успешно загружена:", config)
    pass
