import re
from collections import defaultdict
from datetime import datetime

# --- Конфигурация ---
# Путь к лог-файлу (замените на ваш)
LOG_FILE_PATH = "access.log"
# Порог срабатывания: количество ошибок
THRESHOLD = 5 
# Ключевое слово, сигнализирующее о неудачном входе
FAILED_LOGIN_KEYWORD = "Failed password" 

def analyze_logs(file_path):
    # Словарь для хранения количества неудачных попыток по IP
    # Формат: { "192.168.1.1": количество_ошибок }
    failed_attempts = defaultdict(int)

    # Регулярное выражение для извлечения IPv4 адреса
    ip_pattern = re.compile(r'(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})')

    try:
        with open(file_path, 'r') as file:
            for line in file:
                # Проверяем, содержит ли строка запись о неудачном входе
                if FAILED_LOGIN_KEYWORD in line:
                    match = ip_pattern.search(line)
                    if match:
                        ip_address = match.group(1)
                        failed_attempts[ip_address] += 1

        # Проверка порогового значения и генерация алертов
        generate_alerts(failed_attempts)

    except FileNotFoundError:
        print(f"Ошибка: Файл {file_path} не найден.")
    except Exception as e:
        print(f"Произошла ошибка: {e}")

def generate_alerts(attempts_dict):
    print(f"--- Отчет службы безопасности ({datetime.now().strftime('%Y-%m-%d %H:%M:%S')}) ---")
    alerts_triggered = False

    for ip, count in attempts_dict.items():
        if count >= THRESHOLD:
            print(f"[ALERT] Подозрительная активность! IP: {ip} | Неудачных попыток: {count}")
            alerts_triggered = True
    
    if not alerts_triggered:
        print("Подозрительной активности не обнаружено.")

if __name__ == "__main__":
    # Для теста создадим пример лог-файла, если его нет
    with open("access.log", "w") as f:
        f.write("Jan 14 20:00:01 server1 Failed password for root from 192.168.1.10\n")
        f.write("Jan 14 20:00:02 server1 Failed password for root from 192.168.1.10\n")
        f.write("Jan 14 20:00:03 server1 Failed password for root from 192.168.1.10\n")
        f.write("Jan 14 20:00:04 server1 Failed password for root from 192.168.1.10\n")
        f.write("Jan 14 20:00:05 server1 Failed password for root from 192.168.1.10\n")
        f.write("Jan 14 20:00:06 server1 Accepted password for admin from 10.0.0.5\n")

    analyze_logs(LOG_FILE_PATH)
