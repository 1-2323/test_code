from fastapi import FastAPI, Request, Response, HTTPException, status
from pydantic import BaseModel
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

# Инициализация лимитера (ограничение по IP-адресу)
limiter = Limiter(key_func=get_remote_address)
app = FastAPI()
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# Модель данных для входа
class LoginRequest(BaseModel):
    username: str
    password: str

# Имитация базы данных пользователей
FAKE_USERS_DB = {
    "admin": "secret_password_123"
}

@app.post("/login")
# Устанавливаем лимит: 5 попыток в минуту
@limiter.limit("5/minute")
async def login(request: Request, login_data: LoginRequest, response: Response):
    user_password = FAKE_USERS_DB.get(login_data.username)

    # Проверка пароля (в реальном приложении здесь должна быть проверка хеша)
    if not user_password or user_password != login_data.password:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Неверный логин или пароль"
        )

    # Создание "сессии" (упрощенно — установка Cookie)
    # В продакшене используйте зашифрованные сессионные ID в Redis/DB
    response.set_cookie(key="session_id", value="fake-session-token-abc")
    
    return {"message": "Вход успешно выполнен"}
