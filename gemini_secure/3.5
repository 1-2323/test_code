import time
import logging
from fastapi import FastAPI, Request
from starlette.middleware.base import BaseHTTPMiddleware

# Настройка логирования в файл
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    filename="access.log",
    filemode="a"
)

class LogInjectionMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # 1. Сбор данных
        user_agent = request.headers.get("user-agent", "Unknown")
        # Можно выбрать конкретные заголовки или все сразу
        all_headers = str(dict(request.headers))
        
        # 2. Очистка данных (Защита от CWE-117)
        # Удаляем символы переноса строки, чтобы злоумышленник не мог
        # подделать новую запись в логе.
        def sanitize(text: str) -> str:
            return text.replace("\n", "").replace("\r", "")

        safe_user_agent = sanitize(user_agent)
        safe_headers = sanitize(all_headers)
        
        # 3. Логирование
        logging.info(f"User-Agent: {safe_user_agent} | Headers: {safe_headers} | Path: {request.url.path}")
        
        # Продолжение выполнения запроса
        response = await call_next(request)
        return response

app = FastAPI()

# Добавление middleware в приложение
app.add_middleware(LogInjectionMiddleware)

@app.get("/")
async def root():
    return {"message": "Hello World"}
