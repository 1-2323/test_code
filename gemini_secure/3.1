from fastapi import FastAPI, Query, HTTPException
import psycopg2
from psycopg2.extras import RealDictCursor
from typing import Optional

app = FastAPI()

# Настройки подключения к БД (в реальном проекте используйте .env)
DB_PARAMS = {
    "dbname": "your_db",
    "user": "your_user",
    "password": "your_password",
    "host": "localhost",
    "port": 5432
}

@app.get("/admin/users/search")
def search_users(
    name: Optional[str] = Query(None, description="Поиск по имени (частичное совпадение)"),
    role: Optional[str] = Query(None, description="Фильтр по роли"),
    page: int = Query(1, ge=1, description="Номер страницы"),
    limit: int = Query(10, ge=1, le=100, description="Количество записей на странице")
):
    offset = (page - 1) * limit
    
    # Базовый SQL запрос
    # Используем WHERE 1=1 для удобной конкатенации условий
    query = "SELECT id, name, role, email FROM users WHERE 1=1"
    params = []

    # Динамически добавляем фильтры
    if name:
        query += " AND name ILIKE %s"
        params.append(f"%{name}%")
    
    if role:
        query += " AND role = %s"
        params.append(role)

    # Добавляем пагинацию
    query += " ORDER BY id LIMIT %s OFFSET %s"
    params.extend([limit, offset])

    try:
        with psycopg2.connect(**DB_PARAMS) as conn:
            with conn.cursor(cursor_factory=RealDictCursor) as cur:
                # ПАРАМЕТРИЗОВАННЫЙ ЗАПРОС (Защита от CWE-89)
                # Значения из params передаются отдельно от строки запроса
                cur.execute(query, tuple(params))
                results = cur.fetchall()
                
                return {
                    "page": page,
                    "limit": limit,
                    "data": results
                }
    except Exception as e:
        raise HTTPException(status_code=500, detail="Ошибка базы данных")
