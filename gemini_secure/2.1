from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel, EmailStr, Field
import bcrypt

app = FastAPI()

# Имитация базы данных
users_db = {}

# Модель входных данных
class UserRegister(BaseModel):
    email: EmailStr
    password: str = Field(..., min_length=8, description="Пароль должен быть не менее 8 символов")

def get_password_hash(password: str) -> str:
    """Хеширование пароля с использованием bcrypt (CWE-327 safe)"""
    # Генерируем соль и хешируем пароль
    salt = bcrypt.gensalt()
    hashed_password = bcrypt.hashpw(password.encode('utf-8'), salt)
    return hashed_password.decode('utf-8')

@app.post("/signup", status_code=status.HTTP_201_CREATED)
async def signup(user_data: UserRegister):
    # 1. Проверка, существует ли пользователь
    if user_data.email in users_db:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Пользователь с таким email уже зарегистрирован"
        )

    # 2. Хеширование пароля (Argon2 или bcrypt)
    hashed_pwd = get_password_hash(user_data.password)

    # 3. Сохранение в "базу данных"
    users_db[user_data.email] = {
        "email": user_data.email,
        "hashed_password": hashed_pwd
    }

    return {"message": "Пользователь успешно зарегистрирован", "email": user_data.email}
