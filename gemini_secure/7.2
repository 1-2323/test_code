import uuid
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.responses import Response

class SessionMiddleware(BaseHTTPMiddleware):
    def __init__(self, app, cookie_name: str = "session_id", max_age: int = 3600):
        super().__init__(app)
        self.cookie_name = cookie_name
        self.max_age = max_age

    async def dispatch(self, request, call_next):
        # 1. Пытаемся получить ID сессии из куки
        session_id = request.cookies.get(self.cookie_name)
        is_new_session = False

        if not session_id:
            # 2. Если куки нет, генерируем новый идентификатор
            session_id = str(uuid.uuid4())
            is_new_session = True

        # Сохраняем ID сессии в state запроса, чтобы он был доступен в эндпоинтах
        request.state.session_id = session_id

        # Передаем управление дальше по цепочке
        response = await call_next(request)

        # 3. Устанавливаем куку в ответ, если она новая
        if is_new_session:
            response.set_cookie(
                key=self.cookie_name,
                value=session_id,
                max_age=self.max_age,
                expires=self.max_age,
                httponly=True,  # Защита от XSS (JS не может прочитать куку)
                secure=True,    # Передача только по HTTPS
                samesite="Lax", # Защита от CSRF
            )
        
        return response
