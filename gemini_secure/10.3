from fastapi import FastAPI, UploadFile, File, HTTPException, status
from PIL import Image
import io

app = FastAPI()

# --- Конфигурация безопасности ---
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB
MAX_IMAGE_PIXELS = 5_000_000      # 5 Мегапикселей (например, 2500x2000)
ALLOWED_FORMATS = {"image/jpeg", "image/png"}

# Установка лимита пикселей в Pillow для защиты от декомпрессионных бомб
Image.MAX_IMAGE_PIXELS = MAX_IMAGE_PIXELS

@app.post("/image/process")
async def process_image(
    file: UploadFile = File(...), 
    width: int = 800, 
    height: int = 600
):
    # 1. Проверка формата файла
    if file.content_type not in ALLOWED_FORMATS:
        raise HTTPException(status_code=400, detail="Неподдерживаемый формат файла")

    # 2. Проверка размера файла (по заголовку Content-Length)
    # Это первичная защита от слишком тяжелых запросов
    body = await file.read()
    if len(body) > MAX_FILE_SIZE:
        raise HTTPException(status_code=413, detail="Файл слишком большой")

    try:
        # 3. Открытие изображения
        img = Image.open(io.BytesIO(body))
        
        # 4. Проверка реального разрешения (защита от Image Bomb)
        # Pillow может выбросить DecompressionBombError благодаря Image.MAX_IMAGE_PIXELS
        actual_pixels = img.width * img.height
        if actual_pixels > MAX_IMAGE_PIXELS:
            raise HTTPException(status_code=400, detail="Разрешение изображения слишком велико")

        # 5. Обработка (Изменение размера)
        # Используем Resampling.LANCZOS для сохранения качества
        img_resized = img.resize((width, height), Image.Resampling.LANCZOS)

        # Сохранение результата в буфер
        buffer = io.BytesIO()
        img_resized.save(buffer, format=img.format)
        buffer.seek(0)

        return {"message": f"Изображение изменено до {width}x{height}", "format": img.format}

    except Image.DecompressionBombError:
        raise HTTPException(status_code=400, detail="Обнаружена Image Bomb (слишком много пикселей)")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ошибка обработки: {str(e)}")
