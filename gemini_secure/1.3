from fastapi import FastAPI, Depends, HTTPException, status
from pydantic import BaseModel
from typing import Dict, Any
import json

app = FastAPI()

# 1. Схема данных (Валидация)
class GlobalSettings(BaseModel):
    site_title: str
    maintenance_mode: bool
    api_rates: int
    allowed_locales: list[str]

# 2. Имитация получения текущего пользователя
# В реальном приложении здесь будет логика проверки JWT
async def get_current_user():
    # Пример структуры пользователя
    return {"id": 1, "username": "admin", "is_admin": True}

# 3. Middleware для Vertical Privilege Escalation
def admin_required(user: dict = Depends(get_current_user)):
    if not user.get("is_admin"):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="У вас недостаточно прав для выполнения этого действия"
        )
    return user

# 4. Эндпоинт
@app.post("/api/settings/global")
async def update_global_settings(
    settings: GlobalSettings, 
    admin: dict = Depends(admin_required)
):
    """
    Обновляет глобальные настройки. 
    Доступно только пользователям с флагом is_admin.
    """
    try:
        # Сохранение в файл конфигурации (упрощенный пример)
        with open("config.json", "w") as f:
            json.dump(settings.model_dump(), f, indent=4)
        
        return {"status": "success", "message": "Settings updated successfully"}
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ошибка сохранения: {str(e)}")
