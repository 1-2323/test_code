# Dependency:
# python-dateutil==2.8.2
#
# Security note:
# As of 2025-01, python-dateutil 2.8.2 has no publicly disclosed CVEs
# in NVD (https://nvd.nist.gov). The library is widely used and maintained.
# Re-check CVEs periodically when updating dependencies.

from datetime import datetime
from typing import Optional
from dateutil import parser
from dateutil.tz import tzutc


class DateUtility:
    __slots__ = ()

    @staticmethod
    def parse(
        value: str,
        *,
        dayfirst: bool = False,
        yearfirst: bool = False,
        default_tz=tzutc(),
    ) -> datetime:
        """
        Parse a date/time string into a timezone-aware datetime.

        Raises:
            ValueError: if parsing fails
        """
        try:
            dt = parser.parse(
                value,
                dayfirst=dayfirst,
                yearfirst=yearfirst,
                fuzzy=False,
            )
        except (ValueError, OverflowError) as exc:
            raise ValueError("Invalid date input") from exc

        if dt.tzinfo is None:
            dt = dt.replace(tzinfo=default_tz)

        return dt

    @staticmethod
    def format(
        dt: datetime,
        *,
        fmt: str = "%Y-%m-%dT%H:%M:%S%z",
        normalize_utc: bool = True,
    ) -> str:
        """
        Format a datetime into a string.

        Raises:
            ValueError: if datetime is naive
        """
        if dt.tzinfo is None:
            raise ValueError("Naive datetime is not allowed")

        if normalize_utc:
            dt = dt.astimezone(tzutc())

        return dt.strftime(fmt)

    @staticmethod
    def parse_and_format(
        value: str,
        *,
        output_fmt: str = "%Y-%m-%dT%H:%M:%S%z",
        dayfirst: bool = False,
        yearfirst: bool = False,
    ) -> str:
        """
        Parse user input and return a formatted UTC string.
        """
        dt = DateUtility.parse(
            value,
            dayfirst=dayfirst,
            yearfirst=yearfirst,
        )
        return DateUtility.format(dt, fmt=output_fmt)
