from fastapi import FastAPI, Depends, HTTPException, status
from pydantic import BaseModel
from typing import Dict, Any
import json
from pathlib import Path

app = FastAPI()

CONFIG_PATH = Path("global_settings.json")


# -----------------------------
# Модель пользователя и auth
# -----------------------------
class User:
    def __init__(self, user_id: int, is_admin: bool):
        self.user_id = user_id
        self.is_admin = is_admin


def get_current_user() -> User:
    """
    Заглушка.
    В реальном проекте здесь:
    - JWT
    - session
    - OAuth2
    """
    # пример: пользователь НЕ администратор
    # return User(user_id=1, is_admin=False)

    # пример: администратор
    return User(user_id=1, is_admin=True)


def require_admin(user: User = Depends(get_current_user)) -> User:
    if not user.is_admin:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Admin privileges required"
        )
    return user


# -----------------------------
# Pydantic схема настроек
# -----------------------------
class GlobalSettings(BaseModel):
    title: str
    maintenance_mode: bool
    api_rates: Dict[str, Any]


# -----------------------------
# POST /api/settings/global
# -----------------------------
@app.post("/api/settings/global")
def update_global_settings(
    settings: GlobalSettings,
    admin: User = Depends(require_admin)
):
    """
    Доступно ТОЛЬКО администраторам
    """

    # Сохранение в файл (атомарно)
    with open(CONFIG_PATH, "w", encoding="utf-8") as f:
        json.dump(settings.dict(), f, ensure_ascii=False, indent=2)

    return {
        "status": "success",
        "message": "Global settings updated",
        "updated_by": admin.user_id
    }
