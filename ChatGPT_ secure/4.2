from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, Field
from typing import List
from decimal import Decimal

app = FastAPI()

# ---- Models ----

class Item(BaseModel):
    product_id: int
    quantity: int = Field(gt=0)

class CheckoutRequest(BaseModel):
    items: List[Item]
    total_price: Decimal  # принимается, но не используется

# ---- Storage stubs (заменить на БД) ----

def get_product_price(product_id: int) -> Decimal:
    prices = {
        1: Decimal("499.99"),
        2: Decimal("1299.00"),
        3: Decimal("199.50"),
    }
    price = prices.get(product_id)
    if price is None:
        raise HTTPException(status_code=400, detail="Invalid product")
    return price

def create_order(items: list, total_price: Decimal):
    pass

# ---- Endpoint ----

@app.post("/checkout", status_code=201)
def checkout(req: CheckoutRequest):
    if not req.items:
        raise HTTPException(status_code=400, detail="Cart is empty")

    total = Decimal("0")
    normalized_items = []

    for item in req.items:
        price = get_product_price(item.product_id)
        line_total = price * item.quantity
        total += line_total
        normalized_items.append({
            "product_id": item.product_id,
            "quantity": item.quantity,
            "unit_price": price
        })

    create_order(normalized_items, total)
    return {"total_price": total}
