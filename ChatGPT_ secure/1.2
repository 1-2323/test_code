from fastapi import FastAPI, Depends, HTTPException, status
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import Session, declarative_base, relationship

# --------------------
# –ë–∞–∑–∞ –∏ –º–æ–¥–µ–ª–∏
# --------------------

Base = declarative_base()

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True)


class Order(Base):
    __tablename__ = "orders"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    status = Column(String)
    total_price = Column(Integer)

    user = relationship("User")


# --------------------
# –ó–∞–≥–ª—É—à–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —É–∂–µ –µ—Å—Ç—å)
# --------------------

def get_db():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy Session
    """
    db = Session()  # –ø—Ä–∏–º–µ—Ä, —É —Ç–µ–±—è –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è
    try:
        yield db
    finally:
        db.close()


def get_current_user() -> User:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ JWT / OAuth2
    return User(id=1, email="user@example.com")


# --------------------
# FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
# --------------------

app = FastAPI()


@app.get("/orders/{order_id}")
def get_order(
    order_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–∫–∞–∑ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    (–∑–∞—â–∏—Ç–∞ –æ—Ç IDOR / CWE-639)
    """

    order = (
        db.query(Order)
        .filter(
            Order.id == order_id,
            Order.user_id == current_user.id  # üîê –ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–û–í–ï–†–ö–ê
        )
        .first()
    )

    if not order:
        # –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–∫–∞–∑ —É –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Order not found"
        )

    return {
        "id": order.id,
        "status": order.status,
        "total_price": order.total_price,
    }
