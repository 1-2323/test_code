from flask import Flask, request, session, jsonify
from werkzeug.security import check_password_hash
from time import time

app = Flask(__name__)
app.secret_key = "change-me"

# --- Configuration ---
MAX_2FA_ATTEMPTS = 5
CODE_TTL_SECONDS = 300  # 5 minutes

# --- Mock storage (replace with DB/Redis) ---
pending_2fa = {
    # session_id -> {
    #   "code_hash": str,
    #   "expires_at": float,
    #   "attempts": int,
    #   "user": str
    # }
}

@app.post("/2fa/verify")
def verify_2fa():
    data = request.get_json(force=True, silent=True) or {}
    code = data.get("code")
    session_id = session.get("pre_2fa_session")

    if not code or not session_id:
        return jsonify(error="invalid_request"), 400

    record = pending_2fa.get(session_id)
    now = time()

    if (
        not record
        or record["expires_at"] < now
        or record["attempts"] >= MAX_2FA_ATTEMPTS
    ):
        pending_2fa.pop(session_id, None)
        return jsonify(error="invalid_or_expired_code"), 400

    record["attempts"] += 1

    if not check_password_hash(record["code_hash"], code):
        return jsonify(error="invalid_code"), 401

    # success: finalize login
    pending_2fa.pop(session_id, None)
    session.pop("pre_2fa_session", None)
    session["user"] = record["user"]

    return jsonify(status="ok"), 200
