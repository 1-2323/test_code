import os
import base64
import secrets
from cryptography.hazmat.primitives.ciphers.aead import AESGCM


class SecretManager:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
    —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-256-GCM.
    """

    KEY_SIZE = 32          # 256 –±–∏—Ç
    IV_SIZE = 12           # 96 –±–∏—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è GCM)
    ENV_VAR = "SECRET_KEY_BASE64"

    def __init__(self):
        key_b64 = os.getenv(self.ENV_VAR)
        if not key_b64:
            raise RuntimeError(
                f"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è {self.ENV_VAR} –Ω–µ –∑–∞–¥–∞–Ω–∞"
            )

        key = base64.b64decode(key_b64)
        if len(key) != self.KEY_SIZE:
            raise ValueError("–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 32 –±–∞–π—Ç–∞ (AES-256)")

        self._aesgcm = AESGCM(key)

    def encrypt(self, secret: str) -> str:
        """
        –®–∏—Ñ—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Base64: IV + ciphertext + auth_tag
        """
        iv = secrets.token_bytes(self.IV_SIZE)

        ciphertext = self._aesgcm.encrypt(
            iv,
            secret.encode("utf-8"),
            None  # AAD (associated data), –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        )

        encrypted = iv + ciphertext
        return base64.b64encode(encrypted).decode("utf-8")

    def decrypt(self, encrypted_b64: str) -> str:
        """
        –î–µ—à–∏—Ñ—Ä—É–µ—Ç Base64-—Å—Ç—Ä–æ–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
        """
        encrypted = base64.b64decode(encrypted_b64)

        iv = encrypted[:self.IV_SIZE]
        ciphertext = encrypted[self.IV_SIZE:]

        plaintext = self._aesgcm.decrypt(
            iv,
            ciphertext,
            None
        )

        return plaintext.decode("utf-8")


def generate_key_base64() -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∏–ø—Ç–æ—Å—Ç–æ–π–∫–∏–π –∫–ª—é—á AES-256 –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Base64
    """
    key = secrets.token_bytes(32)
    return base64.b64encode(key).decode("utf-8")


if __name__ == "__main__":
    # üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ (–¥–µ–ª–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
    # export SECRET_KEY_BASE64="<–≤—ã–≤–æ–¥ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏>"
    if not os.getenv("SECRET_KEY_BASE64"):
        print("–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª—é—á –∏ –∑–∞–¥–∞–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
        print(generate_key_base64())
        exit(1)

    manager = SecretManager()

    api_key = "my-super-secret-api-key"

    encrypted = manager.encrypt(api_key)
    print("Encrypted:", encrypted)

    decrypted = manager.decrypt(encrypted)
    print("Decrypted:", decrypted)
