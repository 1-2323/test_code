from fastapi import FastAPI, Request, Response
from starlette.middleware.base import BaseHTTPMiddleware

ALLOWED_ORIGINS = {
    "https://example.com",
    "https://admin.example.com",
}

ALLOWED_METHODS = "GET,POST,PUT,PATCH,DELETE,OPTIONS"
ALLOWED_HEADERS = "Authorization,Content-Type"
ALLOW_CREDENTIALS = "true"


class CORSMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        origin = request.headers.get("origin")

        if request.method == "OPTIONS":
            response = Response(status_code=204)
        else:
            response = await call_next(request)

        if origin in ALLOWED_ORIGINS:
            response.headers["Access-Control-Allow-Origin"] = origin
            response.headers["Access-Control-Allow-Methods"] = ALLOWED_METHODS
            response.headers["Access-Control-Allow-Headers"] = ALLOWED_HEADERS
            response.headers["Access-Control-Allow-Credentials"] = ALLOW_CREDENTIALS
            response.headers["Vary"] = "Origin"

        return response


app = FastAPI()
app.add_middleware(CORSMiddleware)
