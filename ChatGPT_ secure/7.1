from flask import Flask, request, session, jsonify
from werkzeug.security import check_password_hash
from time import time

app = Flask(__name__)
app.secret_key = "change-me"

# --- Configuration ---
MAX_FAILED_ATTEMPTS = 5
BLOCK_SECONDS = 300  # 5 minutes

# --- Mock storage (replace with DB/Redis in production) ---
users = {
    "alice": {"password_hash": "pbkdf2:sha256:260000$..."}  # example hash
}
failed_logins = {}  # key -> {"count": int, "blocked_until": float}

def _rate_limit_key(login: str, ip: str) -> str:
    return f"{login}:{ip}"

@app.post("/login")
def login():
    data = request.get_json(force=True, silent=True) or {}
    login = data.get("login")
    password = data.get("password")
    ip = request.remote_addr or "unknown"

    if not login or not password:
        return jsonify(error="invalid_credentials"), 400

    key = _rate_limit_key(login, ip)
    record = failed_logins.get(key, {"count": 0, "blocked_until": 0})

    now = time()
    if record["blocked_until"] > now:
        return jsonify(error="too_many_attempts"), 429

    user = users.get(login)
    if not user or not check_password_hash(user["password_hash"], password):
        record["count"] += 1
        if record["count"] >= MAX_FAILED_ATTEMPTS:
            record["blocked_until"] = now + BLOCK_SECONDS
        failed_logins[key] = record
        return jsonify(error="invalid_credentials"), 401

    # success
    failed_logins.pop(key, None)
    session["user"] = login
    return jsonify(status="ok"), 200
