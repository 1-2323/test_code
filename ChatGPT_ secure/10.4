import requests
from typing import Optional

class PaymentError(Exception):
    pass

class PaymentClient:
    def __init__(self, base_url: str, timeout: float = 5.0, session: Optional[requests.Session] = None):
        self.base_url = base_url.rstrip("/")
        self.timeout = timeout
        self.session = session or requests.Session()

    def process_payment(self, payload: dict) -> dict:
        """
        Отправляет платеж и обрабатывает ответ платежного API.
        Fail-closed: при ошибках, невалидном ответе или таймаутах платеж считается неуспешным.

        :raises PaymentError: если платеж не подтвержден
        :return: данные успешного платежа
        """
        try:
            resp = self.session.post(
                f"{self.base_url}/payment",
                json=payload,
                timeout=self.timeout,
            )
            resp.raise_for_status()
            data = resp.json()
        except Exception as e:
            raise PaymentError("Payment gateway error") from e

        if not isinstance(data, dict):
            raise PaymentError("Invalid payment response")

        if data.get("status") != "success":
            raise PaymentError("Payment not successful")

        return data
