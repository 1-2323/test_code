import logging
import re
from typing import Callable, Awaitable
from hashlib import sha256

from starlette.middleware.base import BaseHTTPMiddleware
from starlette.requests import Request
from starlette.responses import Response

logger = logging.getLogger("auth_audit")

# --- PII masking utilities ---

_EMAIL_RE = re.compile(r"(^.).*(@.*$)")
_PHONE_RE = re.compile(r"(\+?\d{1,3})?\d{7,10}")

SENSITIVE_KEYS = {
    "password",
    "pass",
    "pwd",
    "token",
    "access_token",
    "refresh_token",
    "authorization",
}


def _mask_email(value: str) -> str:
    return _EMAIL_RE.sub(r"\1***\2", value)


def _mask_phone(value: str) -> str:
    return _PHONE_RE.sub("***", value)


def _mask_value(key: str, value: str) -> str:
    if key.lower() in SENSITIVE_KEYS:
        return "***"
    if "email" in key.lower():
        return _mask_email(value)
    if "phone" in key.lower():
        return _mask_phone(value)
    return value


def _safe_hash(value: str) -> str:
    return sha256(value.encode("utf-8")).hexdigest()


# --- Middleware ---

class AuthAuditMiddleware(BaseHTTPMiddleware):
    """
    Logs successful logins and failed authentication attempts.
    - Never logs passwords or tokens
    - Masks PII (CWE-532)
    """

    def __init__(
        self,
        app,
        login_path: str = "/login",
        success_statuses: set[int] = {200, 204},
        failure_statuses: set[int] = {401, 403},
    ):
        super().__init__(app)
        self.login_path = login_path
        self.success_statuses = success_statuses
        self.failure_statuses = failure_statuses

    async def dispatch(
        self,
        request: Request,
        call_next: Callable[[Request], Awaitable[Response]],
    ) -> Response:
        is_login_attempt = request.url.path == self.login_path
        client_ip = request.client.host if request.client else None
        user_agent = request.headers.get("user-agent")

        body_data = {}
        if is_login_attempt:
            try:
                body = await request.json()
                for k, v in body.items():
                    if isinstance(v, str):
                        body_data[k] = _mask_value(k, v)
            except Exception:
                pass

        response = await call_next(request)

        if is_login_attempt:
            event = {
                "event": "auth.login",
                "status_code": response.status_code,
                "client_ip": client_ip,
                "user_agent": user_agent,
                "request": body_data,
            }

            if response.status_code in self.success_statuses:
                event["result"] = "success"
                logger.info(event)

            elif response.status_code in self.failure_statuses:
                event["result"] = "failure"
                if "username" in body_data:
                    event["principal_hash"] = _safe_hash(
                        str(body_data["username"])
                    )
                logger.warning(event)

        return response
