from fastapi import FastAPI, Body, HTTPException
from pymongo import MongoClient
from typing import Any, Dict

app = FastAPI()

client = MongoClient("mongodb://localhost:27017")
db = client.app_db
collection = db.documents

FORBIDDEN_PREFIX = "$"

def sanitize_query(value: Any) -> Any:
    if isinstance(value, dict):
        sanitized = {}
        for k, v in value.items():
            if k.startswith(FORBIDDEN_PREFIX):
                continue
            sanitized[k] = sanitize_query(v)
        return sanitized
    elif isinstance(value, list):
        return [sanitize_query(v) for v in value]
    else:
        return value

@app.get("/documents/search")
def search_documents(criteria: Dict[str, Any] = Body(...)):
    safe_criteria = sanitize_query(criteria)

    if not safe_criteria:
        raise HTTPException(status_code=400, detail="Invalid search criteria")

    documents = list(collection.find(safe_criteria))
    for doc in documents:
        doc["_id"] = str(doc["_id"])

    return documents
