# Dependencies:
# fastapi==0.110.0
# uvicorn==0.29.0
# Pillow==10.2.0
#
# Security notes:
# - Pillow 10.2.0: no known critical CVEs as of 2025-01.
# - Image size, dimensions, and pixel count are strictly limited
#   to mitigate decompression bomb / DoS attacks (CWE-400).
# - Only safe image formats are allowed.

import os
from pathlib import Path
from fastapi import APIRouter, UploadFile, File, HTTPException, status
from PIL import Image, ImageFile

# Hard limits to prevent DoS
MAX_FILE_SIZE = 5 * 1024 * 1024          # 5 MB
MAX_IMAGE_PIXELS = 10_000_000             # ~10 MP
MAX_WIDTH = 1024
MAX_HEIGHT = 1024
ALLOWED_FORMATS = {"JPEG", "PNG", "WEBP"}

AVATAR_DIR = Path("avatars")
AVATAR_DIR.mkdir(parents=True, exist_ok=True)

Image.MAX_IMAGE_PIXELS = MAX_IMAGE_PIXELS
ImageFile.LOAD_TRUNCATED_IMAGES = False

router = APIRouter()


@router.post("/profile/avatar", status_code=status.HTTP_204_NO_CONTENT)
async def upload_avatar(file: UploadFile = File(...)) -> None:
    if not file.content_type or not file.content_type.startswith("image/"):
        raise HTTPException(status_code=400, detail="Invalid content type")

    data = await file.read()
    if len(data) > MAX_FILE_SIZE:
        raise HTTPException(status_code=413, detail="File too large")

    try:
        with Image.open(file.file if hasattr(file, "file") else None) as img:
            img.verify()
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid image")

    try:
        img = Image.open(file.file)
        img.load()
    except Exception:
        raise HTTPException(status_code=400, detail="Corrupted image")

    if img.format not in ALLOWED_FORMATS:
        raise HTTPException(status_code=400, detail="Unsupported image format")

    img.thumbnail((MAX_WIDTH, MAX_HEIGHT), Image.Resampling.LANCZOS)

    if img.mode not in ("RGB", "RGBA"):
        img = img.convert("RGB")

    filename = "avatar.webp"
    output_path = AVATAR_DIR / filename

    try:
        img.save(
            output_path,
            format="WEBP",
            quality=85,
            method=6,
        )
    except OSError:
        raise HTTPException(status_code=500, detail="Failed to save image")
