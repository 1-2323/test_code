from flask import Flask, request, jsonify
from werkzeug.security import generate_password_hash
from datetime import datetime, timedelta
import hmac
import hashlib

app = Flask(__name__)

# --- Configuration ---
TOKEN_TTL = timedelta(minutes=15)
SECRET_KEY = b"change-me"

# --- Mock storage (replace with DB) ---
users = {
    "alice": {"password_hash": "pbkdf2:sha256:260000$..."}
}
reset_tokens = {
    # token -> {"login": str, "expires_at": datetime}
}

def _verify_token(token: str) -> dict | None:
    record = reset_tokens.get(token)
    if not record:
        return None
    if record["expires_at"] < datetime.utcnow():
        reset_tokens.pop(token, None)
        return None
    return record

@app.post("/password-reset/confirm")
def password_reset_confirm():
    data = request.get_json(force=True, silent=True) or {}
    token = data.get("token")
    new_password = data.get("new_password")

    if not token or not new_password:
        return jsonify(error="invalid_request"), 400

    record = _verify_token(token)
    if not record:
        return jsonify(error="invalid_or_expired_token"), 400

    login = record["login"]
    user = users.get(login)
    if not user:
        return jsonify(error="invalid_token"), 400

    user["password_hash"] = generate_password_hash(
        new_password,
        method="pbkdf2:sha256",
        salt_length=16
    )

    reset_tokens.pop(token, None)
    return jsonify(status="ok"), 200
