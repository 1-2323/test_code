from fastapi import FastAPI, Query
import psycopg2
from psycopg2.extras import RealDictCursor

app = FastAPI()

def get_connection():
    return psycopg2.connect(
        dbname="app_db",
        user="app_user",
        password="secret",
        host="localhost",
        port=5432,
    )

@app.get("/admin/users/search")
def search_users(
    name: str | None = Query(None),
    role: str | None = Query(None),
    page: int = Query(1, ge=1),
    limit: int = Query(20, ge=1, le=100),
):
    offset = (page - 1) * limit

    conditions = []
    params = {}

    if name:
        conditions.append("name ILIKE %(name)s")
        params["name"] = f"%{name}%"

    if role:
        conditions.append("role = %(role)s")
        params["role"] = role

    where_clause = ""
    if conditions:
        where_clause = "WHERE " + " AND ".join(conditions)

    sql = f"""
        SELECT id, name, role
        FROM users
        {where_clause}
        ORDER BY id
        LIMIT %(limit)s OFFSET %(offset)s
    """

    params["limit"] = limit
    params["offset"] = offset

    with get_connection() as conn:
        with conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute(sql, params)
            return cur.fetchall()
