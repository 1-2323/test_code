from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import Dict
from decimal import Decimal

app = FastAPI()

PASS_THRESHOLD = Decimal("70.0")

# ---- Models ----

class SubmitRequest(BaseModel):
    test_id: int
    answers: Dict[int, int]  # question_id -> selected_option
    client_score: Decimal   # принимается, но игнорируется

# ---- Storage stubs (заменить на БД) ----

def get_correct_answers(test_id: int) -> Dict[int, int]:
    # question_id -> correct_option
    tests = {
        1: {101: 2, 102: 4, 103: 1}
    }
    data = tests.get(test_id)
    if not data:
        raise HTTPException(status_code=400, detail="Invalid test")
    return data

def issue_certificate(test_id: int):
    pass

# ---- Scoring ----

def calculate_score(correct: Dict[int, int], submitted: Dict[int, int]) -> Decimal:
    total = len(correct)
    if total == 0:
        return Decimal("0")

    earned = sum(
        1 for q_id, right in correct.items()
        if submitted.get(q_id) == right
    )
    return (Decimal(earned) / Decimal(total)) * Decimal("100")

# ---- Endpoint ----

@app.post("/test/submit")
def submit_test(req: SubmitRequest):
    correct_answers = get_correct_answers(req.test_id)
    score = calculate_score(correct_answers, req.answers)

    if score >= PASS_THRESHOLD:
        issue_certificate(req.test_id)
        return {"status": "passed"}

    return {"status": "failed"}
