import requests
from typing import Optional

class LicenseError(Exception):
    pass

def check_license(
    license_key: str,
    server_url: str,
    timeout: float = 5.0,
    session: Optional[requests.Session] = None,
) -> None:
    """
    Проверяет лицензию через внешний сервер.
    Fail-closed: при любой ошибке или недоступности сервера доступ блокируется.

    :raises LicenseError: если лицензия недействительна или проверка невозможна
    """
    sess = session or requests.Session()
    try:
        response = sess.post(
            server_url,
            json={"license_key": license_key},
            timeout=timeout,
        )
        response.raise_for_status()
        data = response.json()
    except Exception as e:
        raise LicenseError("License check failed (fail-closed)") from e

    if not isinstance(data, dict) or data.get("status") != "valid":
        raise LicenseError("Invalid license")
