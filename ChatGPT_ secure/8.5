from fastapi import FastAPI, UploadFile, File, Header, HTTPException
from hashlib import sha256
from pathlib import Path
from typing import Optional

app = FastAPI()

UPLOAD_DIR = Path("/var/uploads")
UPLOAD_DIR.mkdir(parents=True, exist_ok=True)
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50 MB


@app.post("/upload")
async def upload_file(
    file: UploadFile = File(...),
    x_file_hash: Optional[str] = Header(default=None),
) -> dict:
    hasher = sha256()
    size = 0
    target_path = UPLOAD_DIR / file.filename

    try:
        with target_path.open("wb") as out:
            while chunk := await file.read(8192):
                size += len(chunk)
                if size > MAX_FILE_SIZE:
                    raise HTTPException(status_code=413, detail="File too large")
                hasher.update(chunk)
                out.write(chunk)
    finally:
        await file.close()

    if x_file_hash and hasher.hexdigest() != x_file_hash.lower():
        target_path.unlink(missing_ok=True)
        raise HTTPException(status_code=400, detail="File hash mismatch")

    return {"status": "uploaded"}
