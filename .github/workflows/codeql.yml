name: CodeQL SAST (detect only, JSON report)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Run CodeQL analysis (SARIF)
      uses: github/codeql-action/analyze@v3
      with:
        upload: false
        output: codeql-results

    # ⬇️ ВАЖНЫЙ ШАГ: SARIF → JSON
    - name: Convert SARIF to JSON
      run: |
        python << 'EOF'
        import json
        import glob

        sarif_file = glob.glob("codeql-results/*.sarif")[0]

        with open(sarif_file) as f:
            sarif = json.load(f)

        results = sarif["runs"][0]["results"]
        normalized = []

        for r in results:
            loc = r["locations"][0]["physicalLocation"]
            normalized.append({
                "tool": "CodeQL",
                "rule_id": r["ruleId"],
                "severity": r.get("properties", {}).get("severity"),
                "file": loc["artifactLocation"]["uri"],
                "start_line": loc["region"]["startLine"],
                "message": r["message"]["text"],
            })

        with open("codeql-report.json", "w") as f:
            json.dump(normalized, f, indent=2)
        EOF

    - name: Upload CodeQL JSON report
      uses: actions/upload-artifact@v4
      with:
        name: codeql-json-report
        path: codeql-report.json
